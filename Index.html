<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://www.immd.gov.hk; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HK Border Traffic Summary</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&amp;family=JetBrains+Mono:wght@400;500;700&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg-primary: #F0EDE6;
  --bg-card: #FAFAF7;
  --bg-header: #2C3E2D;
  --text-primary: #1A1A1A;
  --text-secondary: #5A5A5A;
  --text-muted: #8A8A8A;
  --accent: #C45C3C;
  --accent-light: #E8D5CC;
  --border: #D6D3CC;
  --border-light: #E8E5DE;
  --arrival-color: #3A7D5C;
  --departure-color: #C45C3C;
  --badge-bg: #EDE9E0;
  --shadow: 0 2px 12px rgba(0,0,0,0.06);
  --shadow-drag: 0 12px 40px rgba(0,0,0,0.15);
  --radius: 10px;
  --table-stripe: #F5F3EE;
  --input-bg: #FFFFFF;
  --total-row-bg: #EDE9E0;
  --yoy-up: #C45C3C;
  --yoy-down: #3A7D5C;
  --yoy-neutral: #8A8A8A;
}
html.dark {
  --bg-primary: #141414;
  --bg-card: #1E1E1E;
  --bg-header: #1A2E1C;
  --text-primary: #E8E4DC;
  --text-secondary: #A8A8A8;
  --text-muted: #6A6A6A;
  --accent: #E07050;
  --accent-light: #3A2820;
  --border: #333;
  --border-light: #2A2A2A;
  --arrival-color: #5EBF8A;
  --departure-color: #E07050;
  --badge-bg: #2A2A2A;
  --shadow: 0 2px 12px rgba(0,0,0,0.3);
  --shadow-drag: 0 12px 40px rgba(0,0,0,0.5);
  --table-stripe: #242424;
  --input-bg: #2A2A2A;
  --total-row-bg: #2A2820;
  --yoy-up: #E07050;
  --yoy-down: #5EBF8A;
  --yoy-neutral: #6A6A6A;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
.app-header {
  background: var(--bg-header);
  color: #F0EDE6;
  padding: 20px 24px;
  display: flex; align-items: center; gap: 14px;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 3px 16px rgba(0,0,0,0.12);
}
.app-header .logo {
  width: 38px; height: 38px;
  background: var(--accent);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700;
  flex-shrink: 0;
}
.app-header h1 {
  font-size: 17px; font-weight: 700; letter-spacing: 0.3px;
  line-height: 1.3;
}
.app-header h1 span { font-weight: 300; opacity: 0.7; font-size: 12px; display: block; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px 16px 60px; }

/* Drag Handle */
.drag-handle {
  cursor: grab; padding: 4px 8px;
  color: var(--text-muted); font-size: 14px;
  user-select: none; touch-action: none;
}
.drag-handle:active { cursor: grabbing; }
.panel-dragging { opacity: 0.85; box-shadow: var(--shadow-drag) !important; z-index: 999; transition: none !important; }

/* Panels */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 16px;
  transition: box-shadow 0.2s, transform 0.2s;
  position: relative;
}
.panel-head {
  display: flex; align-items: center; gap: 8px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-light);
  font-weight: 600; font-size: 14px;
}
.panel-head i { color: var(--accent); font-size: 15px; }
.panel-body { padding: 16px; }

/* Upload Zone */
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 28px 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  position: relative;
}
.upload-zone:hover, .upload-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-light);
}
.upload-zone i { font-size: 28px; color: var(--accent); margin-bottom: 8px; }
.upload-zone p { font-size: 13px; color: var(--text-secondary); }
.upload-zone small { font-size: 11px; color: var(--text-muted); }
.file-info {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; background: var(--badge-bg);
  border-radius: 8px; margin-top: 12px; font-size: 12px;
}
.file-info .fname { flex: 1; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
.file-info .fsize { color: var(--text-muted); }

/* Download Link */
.csv-download-link {
  display: inline-flex; align-items: center; gap: 6px;
  margin-top: 12px;
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  font-family: 'JetBrains Mono', monospace;
  padding: 6px 12px;
  background: var(--badge-bg);
  border-radius: 6px;
  transition: background 0.15s, color 0.15s;
  word-break: break-all;
}
.csv-download-link:hover {
  background: var(--accent);
  color: #fff;
}
.csv-download-link i {
  font-size: 13px;
  color: inherit;
  margin-bottom: 0;
}

/* Date Picker */
.date-picker-row {
  display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;
}
.date-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
.date-group label { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; }
.date-group input, .date-group select {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--input-bg);
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.2s;
}
.date-group input:focus, .date-group select:focus {
  border-color: var(--accent);
}
.range-sep {
  font-size: 20px; color: var(--text-muted);
  padding-bottom: 10px; font-weight: 300;
  flex-shrink: 0;
}
.btn-load {
  font-family: 'Outfit', sans-serif;
  font-size: 14px; font-weight: 600;
  padding: 10px 20px;
  background: var(--accent);
  color: #fff;
  border: none; border-radius: 8px;
  cursor: pointer;
  transition: opacity 0.2s;
  white-space: nowrap;
  min-height: 42px;
}
.btn-load:hover { opacity: 0.85; }
.btn-load:disabled { opacity: 0.5; cursor: not-allowed; }

/* Quick Presets */
.preset-row {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; align-items: center;
}
.preset-label {
  font-size: 11px; color: var(--text-muted); margin-right: 2px;
}
.preset-btn {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; padding: 4px 10px;
  background: var(--badge-bg); color: var(--text-secondary);
  border-radius: 6px; cursor: pointer;
  transition: background 0.15s, color 0.15s;
  border: 1px solid transparent;
}
.preset-btn:hover, .preset-btn.active {
  background: var(--accent); color: #fff;
  border-color: var(--accent);
}

/* Stats */
.stat-cards {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 12px;
}
.stat-card {
  background: var(--bg-card); border: 1px solid var(--border-light);
  border-radius: var(--radius); padding: 16px;
}
.stat-card-title {
  font-size: 12px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; margin-bottom: 12px;
  padding-bottom: 8px; border-bottom: 2px solid var(--border-light);
  display: flex; align-items: center; gap: 6px;
}
.stat-card-title.departure { color: var(--departure-color); border-bottom-color: var(--departure-color); }
.stat-card-title.arrival { color: var(--arrival-color); border-bottom-color: var(--arrival-color); }
.stat-card-title i { font-size: 13px; }
.stat-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 0;
}
.stat-row + .stat-row { border-top: 1px solid var(--border-light); }
.stat-row .stat-label {
  font-size: 11px; color: var(--text-secondary);
  text-transform: uppercase; letter-spacing: 0.5px;
}
.stat-row .stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px; font-weight: 700;
}
.stat-row .stat-value.departure { color: var(--departure-color); }
.stat-row .stat-value.arrival { color: var(--arrival-color); }
.stat-row.sub .stat-label {
  font-size: 10px; color: var(--text-muted);
  padding-left: 8px;
}
.stat-row.sub .stat-value {
  font-size: 16px; font-weight: 500; opacity: 0.8;
}

/* YoY Badge */
.stat-value-wrap {
  display: flex; flex-direction: column; align-items: flex-end; gap: 2px;
}
.yoy-badge {
  display: inline-flex; align-items: center; gap: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; font-weight: 600;
  padding: 2px 7px;
  border-radius: 5px;
  line-height: 1.3;
  white-space: nowrap;
}
.yoy-badge.up {
  color: var(--yoy-up);
  background: rgba(196, 92, 60, 0.1);
}
html.dark .yoy-badge.up {
  background: rgba(224, 112, 80, 0.15);
}
.yoy-badge.down {
  color: var(--yoy-down);
  background: rgba(58, 125, 92, 0.1);
}
html.dark .yoy-badge.down {
  background: rgba(94, 191, 138, 0.15);
}
.yoy-badge.neutral {
  color: var(--yoy-neutral);
  background: rgba(138, 138, 138, 0.1);
}
.yoy-badge i {
  font-size: 9px;
  color: inherit;
  margin-bottom: 0;
}
.yoy-compare-note {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 10px;
  padding-top: 8px;
  border-top: 1px dashed var(--border-light);
  font-style: italic;
}
.yoy-compare-note i {
  font-size: 10px;
  color: var(--text-muted);
  margin-right: 3px;
}

/* Filter Bar */
.filter-bar {
  display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
  margin-bottom: 12px;
}
.filter-bar select {
  font-family: 'Outfit', sans-serif;
  font-size: 16px; padding: 8px 12px;
  border: 1px solid var(--border); border-radius: 8px;
  background: var(--input-bg); color: var(--text-primary);
  outline: none; min-width: 0;
}
.filter-bar select { min-width: 110px; }
.filter-bar select:focus { border-color: var(--accent); }

/* Direction Toggle Buttons */
.dir-toggle {
  display: flex; gap: 0; border-radius: 8px; overflow: hidden;
  border: 1px solid var(--border);
}
.dir-toggle button {
  font-family: 'Outfit', sans-serif;
  font-size: 13px; font-weight: 500;
  padding: 8px 16px;
  border: none;
  background: var(--input-bg);
  color: var(--text-secondary);
  cursor: pointer;
  transition: background 0.15s, color 0.15s;
  white-space: nowrap;
}
.dir-toggle button + button {
  border-left: 1px solid var(--border);
}
.dir-toggle button.active-arrival {
  background: var(--arrival-color);
  color: #fff;
}
.dir-toggle button.active-departure {
  background: var(--departure-color);
  color: #fff;
}
.dir-toggle button:hover:not(.active-arrival):not(.active-departure) {
  background: var(--badge-bg);
}

.btn-export {
  font-family: 'Outfit', sans-serif;
  font-size: 13px; font-weight: 500;
  padding: 8px 14px;
  background: var(--bg-header); color: #F0EDE6;
  border: none; border-radius: 8px;
  cursor: pointer; white-space: nowrap;
  transition: opacity 0.2s;
  margin-left: auto;
}
.btn-export:hover { opacity: 0.85; }

/* Table */
.table-wrap {
  overflow-x: auto;
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
}
table {
  width: 100%; border-collapse: collapse;
  font-size: 13px;
}
thead { background: var(--bg-header); color: #F0EDE6; }
th {
  padding: 10px 14px; text-align: left;
  font-weight: 600; font-size: 11px;
  text-transform: uppercase; letter-spacing: 0.6px;
  white-space: nowrap;
  user-select: none; position: relative;
}
td {
  padding: 9px 14px;
  border-bottom: 1px solid var(--border-light);
  white-space: nowrap;
}
tr:nth-child(even) td { background: var(--table-stripe); }
tr.total-row td {
  background: var(--total-row-bg) !important;
  font-weight: 700; font-size: 14px;
  border-top: 2px solid var(--accent);
}
td.num { font-family: 'JetBrains Mono', monospace; text-align: center; }
td.arrival-cell { color: var(--arrival-color); }
td.departure-cell { color: var(--departure-color); }
tr.group-row td {
  background: var(--accent-light) !important;
  font-weight: 600;
}

/* Toast */
.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: var(--bg-header); color: #F0EDE6;
  padding: 10px 20px; border-radius: 8px;
  font-size: 13px; z-index: 9999;
  opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* Animations */
@keyframes fadeUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.panel { animation: fadeUp 0.4s ease both; }
.panel:nth-child(2) { animation-delay: 0.08s; }
.panel:nth-child(3) { animation-delay: 0.16s; }

/* Responsive */
@media (max-width: 600px) {
  .app-header { padding: 14px 16px; }
  .app-header h1 { font-size: 15px; }
  .container { padding: 12px 10px 40px; }
  .stat-cards { grid-template-columns: 1fr; }
  .stat-row .stat-value { font-size: 18px; }
  .stat-row.sub .stat-value { font-size: 14px; }
  .yoy-badge { font-size: 10px; }
  table { font-size: 12px; }
  th, td { padding: 7px 8px; }
  .range-sep { display: none; }
  .dir-toggle button { padding: 8px 12px; font-size: 12px; }
}

/* Custom Modal */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex; align-items: center; justify-content: center;
  z-index: 10000; opacity: 0; transition: opacity 0.2s;
  pointer-events: none;
}
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal-box {
  background: var(--bg-card); border-radius: 12px;
  padding: 24px; max-width: 380px; width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
}
.modal-box p { font-size: 14px; margin-bottom: 16px; line-height: 1.5; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
.modal-actions button {
  font-family: 'Outfit', sans-serif;
  padding: 8px 16px; border-radius: 8px; border: none;
  font-size: 13px; font-weight: 500; cursor: pointer;
}
.modal-actions .modal-cancel { background: var(--badge-bg); color: var(--text-primary); }
.modal-actions .modal-confirm { background: var(--accent); color: #fff; }

/* Weekend Trend Chart */
.trend-info-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
  margin-bottom: 16px;
}
.trend-info-card {
  background: var(--badge-bg);
  border-radius: 8px;
  padding: 12px 14px;
}
.trend-info-card .trend-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.7px;
  color: var(--text-muted);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.trend-info-card .trend-label i {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 0;
}
.trend-info-card .trend-date {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}
.trend-info-card .trend-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 700;
  line-height: 1.3;
}
.trend-info-card .trend-val.arrival { color: var(--arrival-color); }
.trend-info-card .trend-val.departure { color: var(--departure-color); }
.trend-info-card .trend-val small {
  display: block;
  font-size: 10px;
  font-weight: 400;
  color: var(--text-muted);
  margin-bottom: 2px;
}
.trend-chart-wrap {
  position: relative;
  width: 100%;
  height: 340px;
}
@media (max-width: 600px) {
  .trend-chart-wrap { height: 260px; }
  .trend-info-row { grid-template-columns: 1fr; }
  .trend-info-card .trend-val { font-size: 16px; }
}
</style>
</head>
<body>

<header class="app-header">
  <div class="logo"><i class="fa-solid fa-plane-arrival"></i></div>
  <h1>HK Border Traffic Summary<span>Daily Passenger Traffic by Control Point</span></h1>
</header>

<div class="container" id="panelContainer">

  <!-- Upload Panel -->
  <div class="panel" data-panel="upload" draggable="false">
    <div class="panel-head">
      <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
      <i class="fa-solid fa-cloud-arrow-up"></i> Upload CSV
    </div>
    <div class="panel-body">
      <div class="upload-zone" id="uploadZone">
        <input type="file" accept=".csv" id="fileInput" style="display:none">
        <i class="fa-solid fa-file-csv"></i>
        <p>Click or drop a CSV file here</p>
        <small>Supports Immigration Department standard format</small>
      </div>
      <a class="csv-download-link" id="csvDownloadLink" href="https://www.immd.gov.hk/opendata/eng/transport/immigration_clearance/statistics_on_daily_passenger_traffic.csv" target="_blank" rel="noopener noreferrer">
        <i class="fa-solid fa-external-link-alt"></i>
        Download latest CSV from IMMD
      </a>
      <div id="fileInfo" style="display:none"></div>
    </div>
  </div>

  <!-- Date Range Selection Panel -->
  <div class="panel" data-panel="date" draggable="false">
    <div class="panel-head">
      <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
      <i class="fa-solid fa-calendar-days"></i> Select Date Range
    </div>
    <div class="panel-body">
      <div class="date-picker-row">
        <div class="date-group">
          <label>From</label>
          <input type="date" id="dateFrom">
        </div>
        <span class="range-sep">→</span>
        <div class="date-group">
          <label>To</label>
          <input type="date" id="dateTo">
        </div>
        <button class="btn-load" id="btnLoad" disabled=""><i class="fa-solid fa-magnifying-glass"></i> Query</button>
      </div>
      <div class="preset-row" id="presetRow"></div>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="panel" data-panel="stats" draggable="false" id="statsPanel" style="display:none">
    <div class="panel-head">
      <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
      <i class="fa-solid fa-chart-pie"></i> Overview — <span id="statsDate"></span>
    </div>
    <div class="panel-body">
      <div class="stat-cards" id="statCards"></div>
    </div>
  </div>

  <!-- Weekend Trend Panel -->
  <div class="panel" data-panel="weekendTrend" draggable="false" id="weekendTrendPanel" style="display:none">
    <div class="panel-head">
      <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
      <i class="fa-solid fa-chart-line"></i> Weekend Trend — Past 12 Months
    </div>
    <div class="panel-body">
      <div id="trendInfo"></div>
      <div class="trend-chart-wrap">
        <canvas id="weekendTrendChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Data Table Panel -->
  <div class="panel" data-panel="table" draggable="false" id="tablePanel" style="display:none">
    <div class="panel-head">
      <span class="drag-handle" title="Drag to reorder"><i class="fa-solid fa-grip-vertical"></i></span>
      <i class="fa-solid fa-table-list"></i> Detail Table
    </div>
    <div class="panel-body">
      <div class="filter-bar">
        <div class="dir-toggle" id="dirToggle">
          <button class="active-arrival" data-dir="Arrival"><i class="fa-solid fa-arrow-down"></i> Arrivals</button>
          <button data-dir="Departure"><i class="fa-solid fa-arrow-up"></i> Departures</button>
        </div>
        <button class="btn-export" id="btnExport"><i class="fa-solid fa-download"></i> Export CSV</button>
      </div>
      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Control Point</th>
              <th style="text-align:center">Mainland Visitors</th>
              <th style="text-align:center">HK Residents</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <p id="modalMsg"></p>
    <div class="modal-actions">
      <button class="modal-cancel" id="modalCancel">Cancel</button>
      <button class="modal-confirm" id="modalConfirm">OK</button>
    </div>
  </div>
</div>

<script>
/* ===== Dark Mode ===== */
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  e.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark');
});

/* ===== State ===== */
let csvData = [];
let availableDates = [];
let currentRows = [];       // aggregated rows for the selected range
let activeDirection = 'Arrival'; // default to Arrival
let lastLoadedFromDMY = '';
let lastLoadedToDMY = '';

const $ = id => document.getElementById(id);

/* ===== Toast ===== */
function showToast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

/* ===== CSV Parse ===== */
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(',');
    if (parts.length < 7) continue;
    const dateStr = parts[0].trim();
    const cp = parts[1].trim();
    const dir = parts[2].trim();
    const hk = parseInt(parts[3].replace(/[^0-9-]/g, ''), 10) || 0;
    const ml = parseInt(parts[4].replace(/[^0-9-]/g, ''), 10) || 0;
    const other = parseInt(parts[5].replace(/[^0-9-]/g, ''), 10) || 0;
    const total = parseInt(parts[6].replace(/[^0-9-]/g, ''), 10) || 0;
    rows.push({ date: dateStr, cp, dir, hk, ml, other, total });
  }
  return rows;
}

function parseDMY(s) {
  const p = s.split('-');
  if (p.length !== 3) return null;
  return new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
}
function toInputDate(s) {
  const p = s.split('-');
  if (p.length !== 3) return '';
  return p[2]+'-'+p[1]+'-'+p[0];
}
function fromInputDate(s) {
  const p = s.split('-');
  if (p.length !== 3) return '';
  return p[2]+'-'+p[1]+'-'+p[0];
}
function toDMY(dateObj) {
  const dd = String(dateObj.getDate()).padStart(2, '0');
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const yyyy = dateObj.getFullYear();
  return dd + '-' + mm + '-' + yyyy;
}
function fmtDisplayDate(dmy) {
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const p = dmy.split('-');
  return p[0] + ' ' + months[parseInt(p[1],10)-1] + ' ' + p[2];
}

/* ===== Find most recent weekend (Sat+Sun) in available dates ===== */
function findLastWeekend() {
  let lastSat = null;
  let lastSun = null;

  for (let i = availableDates.length - 1; i >= 0; i--) {
    const dmy = availableDates[i];
    const d = parseDMY(dmy);
    const dow = d.getDay();
    if (dow === 0 && !lastSun) lastSun = dmy;
    if (dow === 6 && !lastSat) lastSat = dmy;

    if (lastSat && lastSun) {
      const satD = parseDMY(lastSat);
      const sunD = parseDMY(lastSun);
      const diff = (sunD - satD) / (1000 * 60 * 60 * 24);
      if (diff === 1) {
        return { from: lastSat, to: lastSun };
      }
      if (satD > sunD) {
        lastSun = null;
      } else {
        lastSat = null;
      }
    }
  }

  if (lastSat) return { from: lastSat, to: lastSat };
  if (lastSun) return { from: lastSun, to: lastSun };
  return null;
}

/* ===== YoY Comparison Logic ===== */

/**
 * Check if a date range consists entirely of weekend days (Saturday/Sunday).
 */
function isWeekendRange(fromDMY, toDMY) {
  const fromD = parseDMY(fromDMY);
  const toD = parseDMY(toDMY);
  const totalDays = Math.round((toD - fromD) / (1000 * 60 * 60 * 24)) + 1;
  for (let i = 0; i < totalDays; i++) {
    const d = new Date(fromD);
    d.setDate(d.getDate() + i);
    const dow = d.getDay();
    if (dow !== 0 && dow !== 6) return false;
  }
  return true;
}

/**
 * For a given date range, find the corresponding YoY comparison date range.
 *
 * - If the selected range is entirely weekend days, find the nearest weekend
 *   around the same time last year. This ensures Sat/Sun compares with Sat/Sun.
 * - Otherwise, shift each date back by exactly 1 year.
 *
 * Returns { fromDMY, toDMY, label } or null if no data available.
 */
function getYoYComparisonRange(fromDMY, toDMY) {
  const fromD = parseDMY(fromDMY);
  const toD = parseDMY(toDMY);
  const rangeDays = Math.round((toD - fromD) / (1000 * 60 * 60 * 24)) + 1;
  const weekendMode = isWeekendRange(fromDMY, toDMY);

  if (weekendMode) {
    // Find the closest matching weekend from ~1 year ago
    // Step 1: get the "same date last year" for the start
    const lastYearFrom = new Date(fromD);
    lastYearFrom.setFullYear(lastYearFrom.getFullYear() - 1);

    // Step 2: find the nearest Saturday to lastYearFrom
    const nearestSat = findNearestSaturday(lastYearFrom);

    // Step 3: build the comparison range with same number of days
    const compFrom = new Date(nearestSat);
    const compTo = new Date(nearestSat);
    compTo.setDate(compTo.getDate() + rangeDays - 1);

    const compFromDMY = toDMY_fn(compFrom);
    const compToDMY = toDMY_fn(compTo);

    // Check if data exists for this range
    const hasData = checkDataExists(compFromDMY, compToDMY);
    if (!hasData) return null;

    const label = rangeDays === 1
      ? fmtDisplayDate(compFromDMY)
      : fmtDisplayDate(compFromDMY) + ' – ' + fmtDisplayDate(compToDMY);

    return { fromDMY: compFromDMY, toDMY: compToDMY, label, weekendAdjusted: true };
  } else {
    // Simple: shift by exactly 1 year
    const lyFrom = new Date(fromD);
    lyFrom.setFullYear(lyFrom.getFullYear() - 1);
    const lyTo = new Date(toD);
    lyTo.setFullYear(lyTo.getFullYear() - 1);

    const compFromDMY = toDMY_fn(lyFrom);
    const compToDMY = toDMY_fn(lyTo);

    const hasData = checkDataExists(compFromDMY, compToDMY);
    if (!hasData) return null;

    const label = compFromDMY === compToDMY
      ? fmtDisplayDate(compFromDMY)
      : fmtDisplayDate(compFromDMY) + ' – ' + fmtDisplayDate(compToDMY);

    return { fromDMY: compFromDMY, toDMY: compToDMY, label, weekendAdjusted: false };
  }
}

function toDMY_fn(dateObj) {
  const dd = String(dateObj.getDate()).padStart(2, '0');
  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
  const yyyy = dateObj.getFullYear();
  return dd + '-' + mm + '-' + yyyy;
}

/**
 * Find the nearest Saturday to a given date (searching +/- 3 days).
 */
function findNearestSaturday(dateObj) {
  const dow = dateObj.getDay(); // 0=Sun..6=Sat
  // Days to nearest Saturday
  let daysToSat;
  if (dow === 6) {
    daysToSat = 0;
  } else if (dow === 0) {
    daysToSat = -1; // go back to previous Saturday
  } else {
    // For Mon(1)..Fri(5), find nearest Sat
    const forwardToSat = 6 - dow;
    const backwardToSat = dow + 1; // to previous Saturday
    daysToSat = forwardToSat <= backwardToSat ? forwardToSat : -backwardToSat;
  }
  const result = new Date(dateObj);
  result.setDate(result.getDate() + daysToSat);
  return result;
}

/**
 * Check if there's any CSV data within a date range.
 */
function checkDataExists(fromDMY, toDMY) {
  const fromD = parseDMY(fromDMY);
  const toD = parseDMY(toDMY);
  return csvData.some(r => {
    const d = parseDMY(r.date);
    return d >= fromD && d <= toD;
  });
}

/**
 * Compute the same 4 stats for a given date range.
 * Returns { mlArrTotal, mlArrSZ, hkDepTotal, hkDepSZ }
 */
function computeStatsForRange(fromDMY, toDMY) {
  const fromD = parseDMY(fromDMY);
  const toD = parseDMY(toDMY);

  const rangeRows = csvData.filter(r => {
    const d = parseDMY(r.date);
    return d >= fromD && d <= toD;
  });

  if (rangeRows.length === 0) return null;

  // Aggregate
  const aggMap = {};
  rangeRows.forEach(r => {
    const key = r.cp + '||' + r.dir;
    if (!aggMap[key]) {
      aggMap[key] = { cp: r.cp, dir: r.dir, hk: 0, ml: 0, other: 0, total: 0 };
    }
    aggMap[key].hk += r.hk;
    aggMap[key].ml += r.ml;
    aggMap[key].other += r.other;
    aggMap[key].total += r.total;
  });
  const aggRows = Object.values(aggMap);

  // Build grouped sums
  const szBorderNames = [
    'lok ma chau spur line', 'shenzhen bay', 'lo wu',
    'heung yuen wai', 'lok ma chau', 'man kam to'
  ];
  const szSet = new Set(szBorderNames);
  const ferryNames = [
    'china ferry terminal', 'harbour control',
    'kai tak cruise terminal', 'macau ferry terminal', 'macao ferry terminal'
  ];
  const fSet = new Set(ferryNames);
  const standaloneSet = new Set([
    'express rail link west kowloon', 'airport', 'hong kong-zhuhai-macao bridge'
  ]);

  const groupSums = {};
  ['Arrival', 'Departure'].forEach(dir => {
    groupSums['sz||' + dir] = { cp: '6 HK-SZ Connecting Borders', dir, hk: 0, ml: 0, other: 0, total: 0, isGroup: true };
    groupSums['ferry||' + dir] = { cp: '4 Ferry Terminals', dir, hk: 0, ml: 0, other: 0, total: 0, isGroup: true };
  });

  const finalRows = [];
  aggRows.forEach(r => {
    const cpLow = r.cp.toLowerCase();
    if (cpLow === 'sha tau kok') return;
    if (szSet.has(cpLow)) {
      groupSums['sz||' + r.dir].hk += r.hk;
      groupSums['sz||' + r.dir].ml += r.ml;
      groupSums['sz||' + r.dir].other += r.other;
      groupSums['sz||' + r.dir].total += r.total;
    }
    if (fSet.has(cpLow)) {
      groupSums['ferry||' + r.dir].hk += r.hk;
      groupSums['ferry||' + r.dir].ml += r.ml;
      groupSums['ferry||' + r.dir].other += r.other;
      groupSums['ferry||' + r.dir].total += r.total;
      return;
    }
    if (standaloneSet.has(cpLow)) {
      r.isGroup = true;
    }
    finalRows.push(r);
  });
  Object.values(groupSums).forEach(g => finalRows.push(g));

  // Extract 4 metrics
  let hkDepTotal = 0, hkDepSZ = 0, mlArrTotal = 0, mlArrSZ = 0;
  finalRows.forEach(r => {
    const cpLow = r.cp.toLowerCase();
    if (r.dir === 'Departure' && cpLow === '6 hk-sz connecting borders') hkDepSZ += r.hk;
    if (r.dir === 'Arrival' && cpLow === '6 hk-sz connecting borders') mlArrSZ += r.ml;
  });
  finalRows.forEach(r => {
    if (!r.isGroup) return;
    if (r.dir === 'Departure') hkDepTotal += r.hk;
    if (r.dir === 'Arrival') mlArrTotal += r.ml;
  });

  return { mlArrTotal, mlArrSZ, hkDepTotal, hkDepSZ };
}

/**
 * Format a YoY percentage as an HTML badge.
 */
function yoyBadgeHTML(currentVal, lastYearVal) {
  if (lastYearVal === null || lastYearVal === undefined || lastYearVal === 0) {
    return '<span class="yoy-badge neutral" title="No YoY data">N/A</span>';
  }
  const pct = ((currentVal - lastYearVal) / Math.abs(lastYearVal)) * 100;
  const sign = pct > 0 ? '+' : '';
  const cls = pct > 0 ? 'up' : pct < 0 ? 'down' : 'neutral';
  const icon = pct > 0
    ? '<i class="fa-solid fa-caret-up"></i>'
    : pct < 0
      ? '<i class="fa-solid fa-caret-down"></i>'
      : '';
  const formatted = sign + Math.round(pct) + '%';
  return '<span class="yoy-badge ' + cls + '" title="YoY: ' + lastYearVal.toLocaleString() + ' → ' + currentVal.toLocaleString() + '">' + icon + ' ' + formatted + '</span>';
}

function ingestCSV(text, filename) {
  csvData = parseCSV(text);
  if (csvData.length === 0) {
    showToast('Failed to parse CSV data');
    return;
  }
  const dateSet = new Set();
  csvData.forEach(r => dateSet.add(r.date));
  availableDates = Array.from(dateSet).sort((a,b) => parseDMY(a) - parseDMY(b));

  // Show file info
  const fi = $('fileInfo');
  fi.style.display = 'block';
  fi.innerHTML = '<div class="file-info"><i class="fa-solid fa-check-circle" style="color:var(--arrival-color)"></i><span class="fname">' +
    filename + '</span><span class="fsize">' + csvData.length.toLocaleString() + ' rows &middot; ' +
    availableDates.length + ' days</span></div>';

  // Setup date pickers
  const first = toInputDate(availableDates[0]);
  const last = toInputDate(availableDates[availableDates.length - 1]);
  const dpFrom = $('dateFrom');
  const dpTo = $('dateTo');
  dpFrom.min = first; dpFrom.max = last;
  dpTo.min = first; dpTo.max = last;
  dpTo.value = last;
  dpFrom.value = last;
  $('btnLoad').disabled = false;

  // Build presets
  buildPresets();

  // Auto-load latest single day
  loadRange(availableDates[availableDates.length - 1], availableDates[availableDates.length - 1]);

  // Render weekend trend chart
  renderWeekendTrend();
}

function buildPresets() {
  const row = $('presetRow');
  row.innerHTML = '<span class="preset-label">Quick:</span>';

  const lastDate = availableDates[availableDates.length - 1];
  const lastD = parseDMY(lastDate);

  const presets = [
    { label: 'Latest Day', days: 0 },
    { label: 'Last Weekend', days: 'weekend' },
    { label: 'Last 7 Days', days: 7 },
    { label: 'Last 14 Days', days: 14 },
    { label: 'Last 30 Days', days: 30 },
    { label: 'Last 90 Days', days: 90 }
  ];

  presets.forEach(p => {
    const btn = document.createElement('span');
    btn.className = 'preset-btn';
    btn.textContent = p.label;
    btn.addEventListener('click', () => {
      let fromDate, toDate;

      if (p.days === 'weekend') {
        const weekend = findLastWeekend();
        if (!weekend) {
          showToast('No weekend data found');
          return;
        }
        fromDate = weekend.from;
        toDate = weekend.to;
      } else {
        toDate = lastDate;
        if (p.days === 0) {
          fromDate = lastDate;
        } else {
          const target = new Date(lastD);
          target.setDate(target.getDate() - p.days + 1);
          fromDate = availableDates.find(d => parseDMY(d) >= target) || availableDates[0];
        }
      }

      $('dateFrom').value = toInputDate(fromDate);
      $('dateTo').value = toInputDate(toDate);
      loadRange(fromDate, toDate);
      document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
    row.appendChild(btn);
  });
}

/* ===== File Upload ===== */
const uploadZone = $('uploadZone');
const fileInput = $('fileInput');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) readFile(file);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) readFile(fileInput.files[0]);
});

// Prevent the download link click from triggering the upload zone
$('csvDownloadLink').addEventListener('click', e => {
  e.stopPropagation();
});

function readFile(file) {
  const reader = new FileReader();
  reader.onload = () => ingestCSV(reader.result, file.name);
  reader.readAsText(file);
}

/* ===== Custom Sort Order ===== */
const szBorderNames = [
  'lok ma chau spur line',
  'shenzhen bay',
  'lo wu',
  'heung yuen wai',
  'lok ma chau',
  'man kam to'
];
const szBorderSet = new Set(szBorderNames);

const ferryTerminals = [
  'china ferry terminal', 'harbour control',
  'kai tak cruise terminal', 'macau ferry terminal',
  'macao ferry terminal'
];
const ferrySet = new Set(ferryTerminals);

const removeSet = new Set(['sha tau kok']);

function getSortCategory(cpLower) {
  if (cpLower === '6 hk-sz connecting borders') return 0;
  if (szBorderSet.has(cpLower)) return 1;
  if (cpLower === 'express rail link west kowloon') return 2;
  if (cpLower === 'airport') return 3;
  if (cpLower === 'hong kong-zhuhai-macao bridge') return 4;
  if (cpLower === '4 ferry terminals') return 5;
  return 6;
}

function customSortRows(rows, direction) {
  return rows.slice().sort((a, b) => {
    const catA = getSortCategory(a.cp.toLowerCase());
    const catB = getSortCategory(b.cp.toLowerCase());
    if (catA !== catB) return catA - catB;
    if (catA === 1) {
      // SZ border control points: sort by ML desc for Arrival, HK desc for Departure
      if (direction === 'Arrival') {
        return b.ml - a.ml;
      } else {
        return b.hk - a.hk;
      }
    }
    return 0;
  });
}

/* ===== Load Date Range ===== */
function loadRange(fromDMY, toDMY) {
  const fromD = parseDMY(fromDMY);
  const toD = parseDMY(toDMY);
  if (!fromD || !toD || fromD > toD) {
    showToast('Invalid date range');
    return;
  }

  lastLoadedFromDMY = fromDMY;
  lastLoadedToDMY = toDMY;

  // Filter rows in the range
  const rangeRows = csvData.filter(r => {
    const d = parseDMY(r.date);
    return d >= fromD && d <= toD;
  });

  if (rangeRows.length === 0) {
    showToast('No data found for selected range');
    return;
  }

  // Aggregate by control point + direction
  const aggMap = {};
  rangeRows.forEach(r => {
    const key = r.cp + '||' + r.dir;
    if (!aggMap[key]) {
      aggMap[key] = { cp: r.cp, dir: r.dir, hk: 0, ml: 0, other: 0, total: 0 };
    }
    aggMap[key].hk += r.hk;
    aggMap[key].ml += r.ml;
    aggMap[key].other += r.other;
    aggMap[key].total += r.total;
  });
  let aggRows = Object.values(aggMap);

  // Build grouped sums per direction
  const groupSums = {};
  ['Arrival', 'Departure'].forEach(dir => {
    groupSums['sz||' + dir] = { cp: '6 HK-SZ Connecting Borders', dir, hk: 0, ml: 0, other: 0, total: 0, isGroup: true };
    groupSums['ferry||' + dir] = { cp: '4 Ferry Terminals', dir, hk: 0, ml: 0, other: 0, total: 0, isGroup: true };
  });

  const finalRows = [];
  aggRows.forEach(r => {
    const cpLow = r.cp.toLowerCase();
    if (removeSet.has(cpLow)) return;
    if (szBorderSet.has(cpLow)) {
      groupSums['sz||' + r.dir].hk += r.hk;
      groupSums['sz||' + r.dir].ml += r.ml;
      groupSums['sz||' + r.dir].other += r.other;
      groupSums['sz||' + r.dir].total += r.total;
    }
    if (ferrySet.has(cpLow)) {
      groupSums['ferry||' + r.dir].hk += r.hk;
      groupSums['ferry||' + r.dir].ml += r.ml;
      groupSums['ferry||' + r.dir].other += r.other;
      groupSums['ferry||' + r.dir].total += r.total;
      return;
    }
    const standaloneGroupSet = new Set([
      'express rail link west kowloon',
      'airport',
      'hong kong-zhuhai-macao bridge'
    ]);
    if (standaloneGroupSet.has(cpLow)) {
      r.isGroup = true;
    }
    finalRows.push(r);
  });

  Object.values(groupSums).forEach(g => finalRows.push(g));

  currentRows = finalRows;

  $('statsPanel').style.display = '';
  $('tablePanel').style.display = '';

  // Display date label
  const isSingleDay = fromDMY === toDMY;
  const label = isSingleDay
    ? fmtDisplayDate(fromDMY)
    : fmtDisplayDate(fromDMY) + '  to  ' + fmtDisplayDate(toDMY);
  $('statsDate').textContent = label;

  renderStats(currentRows);
  renderTable();

  const dayCount = availableDates.filter(d => {
    const dd = parseDMY(d);
    return dd >= fromD && dd <= toD;
  }).length;
  showToast('Loaded ' + dayCount + ' day' + (dayCount > 1 ? 's' : ''));
}

$('btnLoad').addEventListener('click', () => {
  const vFrom = $('dateFrom').value;
  const vTo = $('dateTo').value;
  if (!vFrom || !vTo) return;
  loadRange(fromInputDate(vFrom), fromInputDate(vTo));
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
});

/* ===== Direction Toggle ===== */
const dirToggle = $('dirToggle');
dirToggle.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('click', () => {
    activeDirection = btn.dataset.dir;
    dirToggle.querySelectorAll('button').forEach(b => {
      b.classList.remove('active-arrival', 'active-departure');
    });
    if (activeDirection === 'Arrival') {
      btn.classList.add('active-arrival');
    } else {
      btn.classList.add('active-departure');
    }
    renderTable();
  });
});

/* ===== Render Stats ===== */
function renderStats(rows) {
  let hkDepTotal = 0, hkDepSZ = 0;
  let mlArrTotal = 0, mlArrSZ = 0;

  rows.forEach(r => {
    const cpLow = r.cp.toLowerCase();
    const isSZgroup = (cpLow === '6 hk-sz connecting borders');
    if (r.dir === 'Departure' && isSZgroup) hkDepSZ += r.hk;
    if (r.dir === 'Arrival' && isSZgroup) mlArrSZ += r.ml;
  });

  rows.forEach(r => {
    if (!r.isGroup) return;
    if (r.dir === 'Departure') hkDepTotal += r.hk;
    if (r.dir === 'Arrival') mlArrTotal += r.ml;
  });

  // Compute YoY comparison
  let yoyData = null;
  let yoyCompInfo = null;
  if (lastLoadedFromDMY && lastLoadedToDMY) {
    yoyCompInfo = getYoYComparisonRange(lastLoadedFromDMY, lastLoadedToDMY);
    if (yoyCompInfo) {
      yoyData = computeStatsForRange(yoyCompInfo.fromDMY, yoyCompInfo.toDMY);
    }
  }

  const lyMlArrTotal = yoyData ? yoyData.mlArrTotal : null;
  const lyMlArrSZ = yoyData ? yoyData.mlArrSZ : null;
  const lyHkDepTotal = yoyData ? yoyData.hkDepTotal : null;
  const lyHkDepSZ = yoyData ? yoyData.hkDepSZ : null;

  const yoyMlArrTotalHTML = yoyBadgeHTML(mlArrTotal, lyMlArrTotal);
  const yoyMlArrSZHTML = yoyBadgeHTML(mlArrSZ, lyMlArrSZ);
  const yoyHkDepTotalHTML = yoyBadgeHTML(hkDepTotal, lyHkDepTotal);
  const yoyHkDepSZHTML = yoyBadgeHTML(hkDepSZ, lyHkDepSZ);

  // Build comparison note
  let compNote = '';
  if (yoyCompInfo) {
    const noteIcon = yoyCompInfo.weekendAdjusted
      ? '<i class="fa-solid fa-calendar-week"></i>'
      : '<i class="fa-solid fa-calendar-day"></i>';
    const adjText = yoyCompInfo.weekendAdjusted ? ' (weekend-adjusted)' : '';
    compNote = '<div class="yoy-compare-note">' + noteIcon + ' YoY vs ' + yoyCompInfo.label + adjText + '</div>';
  } else if (lastLoadedFromDMY) {
    compNote = '<div class="yoy-compare-note"><i class="fa-solid fa-circle-info"></i> YoY: No comparison data available for last year</div>';
  }

  const sc = $('statCards');
  sc.innerHTML =
    '<div class="stat-card">' +
      '<div class="stat-card-title arrival"><i class="fa-solid fa-arrow-down"></i> Mainland Visitors Arrival</div>' +
      '<div class="stat-row">' +
        '<span class="stat-label">Total</span>' +
        '<div class="stat-value-wrap">' +
          '<span class="stat-value arrival">' + mlArrTotal.toLocaleString() + '</span>' +
          yoyMlArrTotalHTML +
        '</div>' +
      '</div>' +
      '<div class="stat-row sub">' +
        '<span class="stat-label">6 HK-SZ Borders</span>' +
        '<div class="stat-value-wrap">' +
          '<span class="stat-value arrival">' + mlArrSZ.toLocaleString() + '</span>' +
          yoyMlArrSZHTML +
        '</div>' +
      '</div>' +
      compNote +
    '</div>' +
    '<div class="stat-card">' +
      '<div class="stat-card-title departure"><i class="fa-solid fa-arrow-up"></i> HK Residents Departure</div>' +
      '<div class="stat-row">' +
        '<span class="stat-label">Total</span>' +
        '<div class="stat-value-wrap">' +
          '<span class="stat-value departure">' + hkDepTotal.toLocaleString() + '</span>' +
          yoyHkDepTotalHTML +
        '</div>' +
      '</div>' +
      '<div class="stat-row sub">' +
        '<span class="stat-label">6 HK-SZ Borders</span>' +
        '<div class="stat-value-wrap">' +
          '<span class="stat-value departure">' + hkDepSZ.toLocaleString() + '</span>' +
          yoyHkDepSZHTML +
        '</div>' +
      '</div>' +
      compNote +
    '</div>';
}

/* ===== Render Table ===== */
function renderTable() {
  let filtered = currentRows.filter(r => r.dir === activeDirection);
  filtered = customSortRows(filtered, activeDirection);

  const tbody = $('tableBody');
  let html = '';
  let sumHK = 0, sumML = 0;

  // First pass: compute totals for percentage calculation
  filtered.forEach(r => {
    sumHK += r.hk;
    sumML += r.ml;
  });

  filtered.forEach(r => {
    const rowClass = r.isGroup ? ' class="group-row"' : '';
    const mlPct = sumML > 0 ? Math.round((r.ml / sumML) * 100) : 0;
    const hkPct = sumHK > 0 ? Math.round((r.hk / sumHK) * 100) : 0;
    html += '<tr' + rowClass + '>';
    html += '<td>' + r.cp + '</td>';
    html += '<td class="num">' + r.ml.toLocaleString() + ' <span style="color:var(--text-muted);font-size:11px;">(' + mlPct + '%)</span></td>';
    html += '<td class="num">' + r.hk.toLocaleString() + ' <span style="color:var(--text-muted);font-size:11px;">(' + hkPct + '%)</span></td>';
    html += '</tr>';
  });

  html += '<tr class="total-row">';
  html += '<td>TOTAL</td>';
  html += '<td class="num">' + sumML.toLocaleString() + '</td>';
  html += '<td class="num">' + sumHK.toLocaleString() + '</td>';
  html += '</tr>';

  tbody.innerHTML = html;
}

/* ===== Export CSV ===== */
$('btnExport').addEventListener('click', () => {
  if (currentRows.length === 0) return;
  let filtered = currentRows.filter(r => r.dir === activeDirection);
  filtered = customSortRows(filtered, activeDirection);
  const dirLabel = activeDirection;
  const header = 'Control Point,Direction,Mainland Visitors,HK Residents\n';
  const body = filtered.map(r => [r.cp, r.dir, r.ml, r.hk].join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + header + body], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const rangeLabel = $('statsDate').textContent.replace(/\s+/g, '_');
  a.href = url; a.download = 'traffic_' + dirLabel + '_' + rangeLabel + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV exported');
});

/* ===== Drag & Drop Panels ===== */
(function initDrag() {
  const container = $('panelContainer');
  let dragEl = null;
  let placeholder = null;

  function getHandle(el) {
    while (el) {
      if (el.classList && el.classList.contains('drag-handle')) return el;
      el = el.parentElement;
    }
    return null;
  }

  function getPanelFromChild(el) {
    while (el) {
      if (el.classList && el.classList.contains('panel')) return el;
      el = el.parentElement;
    }
    return null;
  }

  container.addEventListener('pointerdown', e => {
    const handle = getHandle(e.target);
    if (!handle) return;
    const panel = getPanelFromChild(handle);
    if (!panel) return;

    e.preventDefault();
    dragEl = panel;
    dragEl.classList.add('panel-dragging');

    placeholder = document.createElement('div');
    placeholder.style.height = dragEl.offsetHeight + 'px';
    placeholder.style.margin = '0 0 16px 0';
    placeholder.style.borderRadius = 'var(--radius)';
    placeholder.style.border = '2px dashed var(--border)';
    placeholder.style.background = 'transparent';

    const startY = e.clientY;
    const startTop = dragEl.getBoundingClientRect().top;
    const containerRect = container.getBoundingClientRect();

    dragEl.style.position = 'fixed';
    dragEl.style.left = containerRect.left + 'px';
    dragEl.style.width = containerRect.width + 'px';
    dragEl.style.top = startTop + 'px';
    dragEl.style.zIndex = '999';
    dragEl.parentNode.insertBefore(placeholder, dragEl.nextSibling);

    function onMove(ev) {
      const dy = ev.clientY - startY;
      dragEl.style.top = (startTop + dy) + 'px';

      const panels = Array.from(container.querySelectorAll('.panel:not(.panel-dragging)'));
      let insertBefore = null;
      for (const p of panels) {
        const rect = p.getBoundingClientRect();
        if (ev.clientY < rect.top + rect.height / 2) {
          insertBefore = p;
          break;
        }
      }
      if (insertBefore) {
        container.insertBefore(placeholder, insertBefore);
      } else {
        container.appendChild(placeholder);
      }
    }

    function onUp() {
      document.removeEventListener('pointermove', onMove);
      document.removeEventListener('pointerup', onUp);
      dragEl.classList.remove('panel-dragging');
      dragEl.style.position = '';
      dragEl.style.left = '';
      dragEl.style.width = '';
      dragEl.style.top = '';
      dragEl.style.zIndex = '';
      container.insertBefore(dragEl, placeholder);
      placeholder.remove();
      dragEl = null;
      placeholder = null;
    }

    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp);
  });
})();

/* ===== Weekend Trend Chart ===== */
var weekendTrendChart = null;

function getCSSVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

function fmtShortDate(dmy) {
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var p = dmy.split('-');
  return parseInt(p[0], 10) + ' ' + months[parseInt(p[1], 10) - 1];
}

function fmtWeekendRange(satDMY) {
  var satD = parseDMY(satDMY);
  var sunD = new Date(satD);
  sunD.setDate(sunD.getDate() + 1);
  var sunDMY = toDMY(sunD);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var sp = satDMY.split('-');
  var up = sunDMY.split('-');
  if (sp[1] === up[1] && sp[2] === up[2]) {
    return parseInt(sp[0],10) + '–' + parseInt(up[0],10) + ' ' + months[parseInt(sp[1],10)-1] + ' ' + sp[2];
  }
  return fmtDisplayDate(satDMY) + ' – ' + fmtDisplayDate(sunDMY);
}

function computeWeekendTrendData() {
  if (csvData.length === 0 || availableDates.length === 0) return null;

  var latestDate = parseDMY(availableDates[availableDates.length - 1]);
  var oneYearAgo = new Date(latestDate);
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

  var weekendMap = {};

  csvData.forEach(function(r) {
    var d = parseDMY(r.date);
    if (d < oneYearAgo) return;
    var dow = d.getDay();
    if (dow !== 0 && dow !== 6) return;

    var sat;
    if (dow === 6) {
      sat = new Date(d);
    } else {
      sat = new Date(d);
      sat.setDate(sat.getDate() - 1);
    }
    var satKey = toDMY(sat);

    if (!weekendMap[satKey]) {
      weekendMap[satKey] = { mlArr: 0, hkDep: 0 };
    }

    if (r.dir === 'Arrival') {
      weekendMap[satKey].mlArr += r.ml;
    } else if (r.dir === 'Departure') {
      weekendMap[satKey].hkDep += r.hk;
    }
  });

  var sortedKeys = Object.keys(weekendMap).sort(function(a, b) {
    return parseDMY(a) - parseDMY(b);
  });

  if (sortedKeys.length < 2) return null;

  var labels = [];
  var labelsFull = [];
  var labelsWeekendFull = [];
  var mlArrData = [];
  var hkDepData = [];

  sortedKeys.forEach(function(key) {
    var entry = weekendMap[key];
    labels.push(fmtShortDate(key));
    labelsFull.push(fmtDisplayDate(key));
    labelsWeekendFull.push(fmtWeekendRange(key));
    mlArrData.push(entry.mlArr);
    hkDepData.push(entry.hkDep);
  });

  var mlPeakIdx = 0;
  var hkPeakIdx = 0;
  mlArrData.forEach(function(v, i) { if (v > mlArrData[mlPeakIdx]) mlPeakIdx = i; });
  hkDepData.forEach(function(v, i) { if (v > hkDepData[hkPeakIdx]) hkPeakIdx = i; });

  return {
    labels: labels,
    labelsFull: labelsFull,
    labelsWeekendFull: labelsWeekendFull,
    mlArrData: mlArrData,
    hkDepData: hkDepData,
    mlPeakIdx: mlPeakIdx,
    hkPeakIdx: hkPeakIdx,
    latestIdx: labels.length - 1
  };
}

function renderWeekendTrend() {
  var data = computeWeekendTrendData();
  var panel = $('weekendTrendPanel');

  if (!data) {
    panel.style.display = 'none';
    return;
  }

  panel.style.display = '';

  var mlPeakIdx = data.mlPeakIdx;
  var hkPeakIdx = data.hkPeakIdx;
  var latestIdx = data.latestIdx;
  var mlArrData = data.mlArrData;
  var hkDepData = data.hkDepData;
  var labelsFull = data.labelsFull;
  var labelsWknd = data.labelsWeekendFull;

  // Build info cards (show full Sat–Sun date range)
  var infoHTML = '<div class="trend-info-row">' +
    '<div class="trend-info-card">' +
      '<div class="trend-label"><i class="fa-solid fa-calendar-check"></i> Latest Weekend</div>' +
      '<div class="trend-date">' + labelsWknd[latestIdx] + '</div>' +
      '<div class="trend-val arrival"><small>Mainland Visitors Arrival</small>' + mlArrData[latestIdx].toLocaleString() + '</div>' +
      '<div class="trend-val departure" style="margin-top:4px"><small>HK Residents Departure</small>' + hkDepData[latestIdx].toLocaleString() + '</div>' +
    '</div>' +
    '<div class="trend-info-card">' +
      '<div class="trend-label"><i class="fa-solid fa-arrow-trend-up"></i> Peak ML Arrivals</div>' +
      '<div class="trend-date">' + labelsWknd[mlPeakIdx] + '</div>' +
      '<div class="trend-val arrival">' + mlArrData[mlPeakIdx].toLocaleString() + '</div>' +
    '</div>' +
    '<div class="trend-info-card">' +
      '<div class="trend-label"><i class="fa-solid fa-arrow-trend-up"></i> Peak HK Departures</div>' +
      '<div class="trend-date">' + labelsWknd[hkPeakIdx] + '</div>' +
      '<div class="trend-val departure">' + hkDepData[hkPeakIdx].toLocaleString() + '</div>' +
    '</div>' +
  '</div>';

  $('trendInfo').innerHTML = infoHTML;

  // Get theme colors
  var arrColor = getCSSVar('--arrival-color');
  var depColor = getCSSVar('--departure-color');
  var textColor = getCSSVar('--text-secondary');
  var gridColor = getCSSVar('--border-light');
  var bgCard = getCSSVar('--bg-card');
  var isDark = document.documentElement.classList.contains('dark');

  // Highlight peak & latest with larger dots
  var mlPointRadius = mlArrData.map(function(_, i) {
    return (i === mlPeakIdx || i === latestIdx) ? 5 : 1.5;
  });
  var hkPointRadius = hkDepData.map(function(_, i) {
    return (i === hkPeakIdx || i === latestIdx) ? 5 : 1.5;
  });

  if (weekendTrendChart) {
    weekendTrendChart.destroy();
    weekendTrendChart = null;
  }

  var ctx = $('weekendTrendChart').getContext('2d');

  // Custom plugin: draw value labels at peak & latest points
  var annotPlugin = {
    id: 'weekendPointLabels',
    afterDatasetsDraw: function(chart) {
      var c = chart.ctx;
      var chartArea = chart.chartArea;

      chart.data.datasets.forEach(function(ds, dsIdx) {
        var meta = chart.getDatasetMeta(dsIdx);
        var peakI = dsIdx === 0 ? mlPeakIdx : hkPeakIdx;
        var indices = [peakI];
        if (latestIdx !== peakI) indices.push(latestIdx);

        indices.forEach(function(idx) {
          var point = meta.data[idx];
          if (!point) return;
          var val = ds.data[idx];
          var text = val.toLocaleString();
          var x = point.x;
          var y = point.y;

          // Dataset 0 labels above, dataset 1 labels below
          var offsetY = dsIdx === 0 ? -14 : 18;

          var textAlign = 'center';
          if (x - 40 < chartArea.left) textAlign = 'left';
          if (x + 40 > chartArea.right) textAlign = 'right';

          c.save();
          c.font = 'bold 10px "JetBrains Mono", monospace';
          c.textAlign = textAlign;
          c.textBaseline = dsIdx === 0 ? 'bottom' : 'top';

          // Stroke background for readability
          c.strokeStyle = bgCard;
          c.lineWidth = 3;
          c.lineJoin = 'round';
          c.strokeText(text, x, y + offsetY);

          c.fillStyle = ds.borderColor;
          c.fillText(text, x, y + offsetY);
          c.restore();
        });
      });
    }
  };

  weekendTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [
        {
          label: 'Mainland Visitor Arrivals',
          data: mlArrData,
          borderColor: arrColor,
          backgroundColor: arrColor + '18',
          fill: true,
          tension: 0.35,
          borderWidth: 2,
          pointRadius: mlPointRadius,
          pointBackgroundColor: arrColor,
          pointBorderColor: arrColor,
          pointHoverRadius: 5
        },
        {
          label: 'HK Residents Departures',
          data: hkDepData,
          borderColor: depColor,
          backgroundColor: depColor + '18',
          fill: true,
          tension: 0.35,
          borderWidth: 2,
          pointRadius: hkPointRadius,
          pointBackgroundColor: depColor,
          pointBorderColor: depColor,
          pointHoverRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: { top: 28, right: 14, bottom: 4, left: 4 }
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            color: textColor,
            font: { family: "'Outfit', sans-serif", size: 12 },
            usePointStyle: true,
            pointStyle: 'circle',
            padding: 16
          }
        },
        tooltip: {
          backgroundColor: isDark ? '#2A2A2A' : '#FAFAF7',
          titleColor: isDark ? '#E8E4DC' : '#1A1A1A',
          bodyColor: isDark ? '#A8A8A8' : '#5A5A5A',
          borderColor: isDark ? '#444' : '#D6D3CC',
          borderWidth: 1,
          padding: 12,
          titleFont: { family: "'Outfit', sans-serif", size: 13, weight: '600' },
          bodyFont: { family: "'JetBrains Mono', monospace", size: 12 },
          callbacks: {
            title: function(items) {
              return labelsWknd[items[0].dataIndex];
            },
            label: function(ctx) {
              return ' ' + ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: textColor,
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            maxRotation: 45,
            autoSkip: true,
            maxTicksLimit: 16
          },
          grid: { color: gridColor + '60' }
        },
        y: {
          ticks: {
            color: textColor,
            font: { family: "'JetBrains Mono', monospace", size: 10 },
            callback: function(value) {
              if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
              if (value >= 1000) return Math.round(value / 1000) + 'K';
              return value;
            }
          },
          grid: { color: gridColor + '60' }
        }
      }
    },
    plugins: [annotPlugin]
  });
}

// Re-render weekend trend chart on theme change
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
  if (weekendTrendChart) {
    setTimeout(renderWeekendTrend, 150);
  }
});

/* ===== Init ===== */
</script>







</body></html>